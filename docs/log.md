# Логи
Обычно логи выводятся в stdout. Они могут передаваться как по UART, так и по сети ([netlog](./netlog.md)).

Не стоит делать логи в тех местах кода, для которых важно быстрое выполнения, поскольку запись
в UART или отправка по TCP/UDP может быть заблокировать задачу на значительное время. Из ISR выводить
логи вообще нельзя.

Уровни сообщений:
1. `E` - ошибка.
2. `W` - предупреждение.
3. `I` - важная информация.
4. `D` - для дебага.
5. `V` - если информация иногда может быть полезна для дебага, но часто выводится и может мешать
   просмотру других сообщений.

В `lib/log_defs.h` объявлены макросы для логов. Перед включением этого файла нужно объявить макрос
`PKLOG_LEVEL`. Все сообщения, уровень которых не ниже `PKLOG_LEVEL`, будут выводиться.
Этот файл можно включать несколько раз в одной единице трансляции.

Но обычно `lib/log_defs.h` отдельно подключать не требуется, можно использовать `lib.h`
(из основной программы) или `lib/inc.h` (из библиотеки). В этих заголовочных файлах уже задан
уровень логов по параметру из конфигурации. `lib/log_defs.h` может понадобиться только для задания
уровня логов локально, для конкретной единицы трансляции.

## Макросы
`PKLOGx(fmt, ...)` - `printf`-подобный макрос, который выводит сообщение уровня `x`. В качестве
тега использует значение `TAG`, которое должно быть объявлено где-то в начале `.c`/`.cpp` файла так:
```c
static const char *TAG = "my_tag";
```

`PKLOGx_TAG(tag, fmt, ...)` - то же, что и `PKLOGx()`, но можно указать тег явно.

`PKLOGx_UART(fmt, ...)`, `PKLOGx_UART_TAG(tag, fmt, ...)` - то же, что и `PKLOGx()`/`PKLOGx_TAG()`,
но выводят только в UART (файл `pk_log_uartout`), даже если включен `netlog`.

Вывод в UART через `netlog` (который работает, когда никто не подписан на рассылку по сети) и через
файл `pk_log_uartout` не синхронизированы.

В качестве `fmt` можно передавать только строковой литерал.

## Конфигурация
```ini
[lib.log]
lib_level=3
app_level=4
print_file_line=true
print_time=true
print_color=true
btrace_on_error=true
```

* `lib_level` - уровень логов для библиотеки.
* `app_level` - уровень логов для основной программы.
* `print_file_line` - выводить номер строки, в которой вызываются макросы логов (вставляется в
  строку препроцессором).
* `print_time` - выводить время в миллисекундах.
* `print_color` - использовать ASCII escape коды для изменения цвета вывода в зависимости от уровня
  сообщения в лог.
* `btrace_on_error` - выводить backtrace для сообщения об ошибке.

